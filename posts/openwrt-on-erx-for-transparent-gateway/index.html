<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=generator content="Hugo 0.74.1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Victor"><meta property="og:url" content="https://maolu.one/posts/openwrt-on-erx-for-transparent-gateway/"><link rel=canonical href=https://maolu.one/posts/openwrt-on-erx-for-transparent-gateway/><link rel=alternate type=application/atom+xml href=https://maolu.one/index.xml title=一间茅庐><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maolu.one\/"},"articleSection":"posts","name":"UBNT ER-X 刷 Open-WRT 并作为透明网关","headline":"UBNT ER-X 刷 Open-WRT 并作为透明网关","description":"一直想在家庭网络中增加一个透明网关，达到让网络中所有设备在访问国外网站时自动使用代理的功能。家中本身有一个 3215U \u002b 4 千兆网口的工控机，但嫌弃其电源实在占位置所以没启用。最近才觉察到 UniFi Switch 8 POE 150W 的网口是可以自定义 PoE\u002b 或 24V Passive PoE 供电的，因为 ER-X 本身体积就小，又支持 24V Passive PoE 供电，这样就可以节省充电器和充电线，仅用一根网线即可供电和数据传输，简约而不简单。 一、编译 ER-X Open-WRT 固件 因为官方 Open-WRT 的固件内容比较素，缺乏必备的 ShadowsocksR Plus 等插件","inLanguage":"en-US","author":"Victor","creator":"Victor","publisher":"Victor","accountablePerson":"Victor","copyrightHolder":"Victor","copyrightYear":"2020","datePublished":"2020-04-07 13:04:01 \u002b0800 \u002b0800","dateModified":"2020-04-07 13:04:01 \u002b0800 \u002b0800","url":"https:\/\/maolu.one\/posts\/openwrt-on-erx-for-transparent-gateway\/","keywords":[]}</script><title>UBNT ER-X 刷 Open-WRT 并作为透明网关 - 一间茅庐</title><meta property="og:title" content="UBNT ER-X 刷 Open-WRT 并作为透明网关 - 一间茅庐"><meta property="og:type" content="article"><meta property="og:description" content="一直想在家庭网络中增加一个透明网关，达到让网络中所有设备在访问国外网站时自动使用代理的功能。家中本身有一个 3215U + 4 千兆网口的工控机，但嫌弃其电源实在占位置所以没启用。最近才觉察到 UniFi Switch 8 POE 150W 的网口是可以自定义 PoE+ 或 24V Passive PoE 供电的，因为 ER-X 本身体积就小，又支持 24V Passive PoE 供电，这样就可以节省充电器和充电线，仅用一根网线即可供电和数据传输，简约而不简单。 一、编译 ER-X Open-WRT 固件 因为官方 Open-WRT 的固件内容比较素，缺乏必备的 ShadowsocksR Plus 等插件"><meta name=description content="一直想在家庭网络中增加一个透明网关，达到让网络中所有设备在访问国外网站时自动使用代理的功能。家中本身有一个 3215U + 4 千兆网口的工控机，但嫌弃其电源实在占位置所以没启用。最近才觉察到 UniFi Switch 8 POE 150W 的网口是可以自定义 PoE+ 或 24V Passive PoE 供电的，因为 ER-X 本身体积就小，又支持 24V Passive PoE 供电，这样就可以节省充电器和充电线，仅用一根网线即可供电和数据传输，简约而不简单。 一、编译 ER-X Open-WRT 固件 因为官方 Open-WRT 的固件内容比较素，缺乏必备的 ShadowsocksR Plus 等插件"><meta property="og:locale" content="zh-CN"><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/highlight/tomorrow.min.css><link rel=stylesheet href=/css/index.css><link rel=stylesheet href=/css/maolu.css><link href=/index.xml rel=alternate type=application/rss+xml title=一间茅庐><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet></head><body><article class=post id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class="signatures site-title"><a href=/>maolu.one</a></div></header><div class=header-line></div></div><header class=post-header><h1 class=post-title>UBNT ER-X 刷 Open-WRT 并作为透明网关</h1><div class="row post-desc"><div class=col-xs-6><b><em>Victor @</em></b>
<time class=post-date datetime="2020-04-07 13:04:01 +0800">07 Apr 2020</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><p>一直想在家庭网络中增加一个透明网关，达到让网络中所有设备在访问国外网站时自动使用代理的功能。家中本身有一个 3215U + 4 千兆网口的工控机，但嫌弃其电源实在占位置所以没启用。最近才觉察到 UniFi Switch 8 POE 150W 的网口是可以自定义 PoE+ 或 24V Passive PoE 供电的，因为 ER-X 本身体积就小，又支持 24V Passive PoE 供电，这样就可以节省充电器和充电线，仅用一根网线即可供电和数据传输，简约而不简单。</p><h2 id=一编译-er-x-open-wrt-固件>一、编译 ER-X Open-WRT 固件</h2><p>因为官方 Open-WRT 的固件内容比较素，缺乏必备的 ShadowsocksR Plus 等插件，所以我采用 Lean 的 Open-WRT 固件自行编译。编译此固件是需要编译机可无障碍访问国外部分网站，在虚拟机上使用：</p><pre><code>$ export all_proxy=&quot;socks5://your.proxy:1080&quot;
</code></pre><p>尝试编译，依然失败，提示有文件无法下载。所以我最终采用在一台 Google Cloud Engine 机器上编译。编译时按照指引，在 make menuconfig 时：</p><ul><li><p>Target System 选择 MediaTek Ralink MIPS</p></li><li><p>Subtarget 选择 MT7621 based boards</p></li><li><p>Target Profile 选择 EdgeRouter X</p></li></ul><p>其余选项不需要动，除非你明白为什么需要动。其他默认参数已经包含了 ShadowsocksR Plus、Adbyby Plus+、KMS服务器等常用功能。</p><p>在最近的更新后，Lean 源码中删除了 SSR Plus + 功能模块。请参考此文做一些修改：解决 Lean 固件编译后无 SSR-Plus + 的问题<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>编译好的固件位于 /lede/bin/targets/ramips/mt7621 目录下。可使用以下语句将其下载到本地：</p><pre><code>// 自行修改 username、ip、/path/to/lede、/path/to/destination
// kernel
$ scp username@ip:/path/to/lede/bin/targets/ramips/mt7621/openwrt-ramips-mt7621-ubiquiti_edgerouterx-initramfs-kerne.bin /path/to/destination
// firmware
$ scp username@ip:/path/to/lede/bin/targets/ramips/mt7621/openwrt-ramips-mt7621-ubiquiti_edgerouterx-squashfs-sysupgrade.bin /path/to/destination
</code></pre><h2 id=二将-open-wrt-刷入-er-x>二、将 Open-WRT 刷入 ER-X</h2><p>参考 Open-WRT 官网的教程，很容易即可将 Open-WRT 刷入ER-X。主要需要两步，一是将官方固件刷写为 Open-WRT 的 Kernel，我称之为过渡固件；而是从过渡固件刷写为正式固件。</p><pre><code>// 上传并刷写过渡固件，假设 ER-X IP 为 192.168.1.1，自行替换 /path/to
$ scp /path/to/openwrt-ramips-mt7621-ubnt-erx-initramfs-kernel.bin ubnt@192.168.1.1:/tmp
$ ssh ubnt@192.168.1.1
ubnt@ubnt:~$ cd /tmp
ubnt@ubnt:/tmp$ add system image openwrt-ramips-mt7621-ubnt-erx-initramfs-kernel.bin
Checking upgrade image...Done
Preparing to upgrade...Done
Copying upgrade image.../usr/bin/ubnt-upgrade: line 509: [: too many arguments
Done
Removing old image...Done
Checking upgrade image...Done
Copying config data...Done
Finishing upgrade...Done
Upgrade completed
ubnt@ubnt:/tmp$ show system image
The system currently has the following image(s) installed:
ramips Bleeding Edge r49395 (default boot)
v1.7.1.4821926.151103.1114 (running image)
A reboot is needed to boot default image
</code></pre><p>如果刷写时，出现以下错误提示：</p><pre><code>ubnt@ubnt:/tmp$ add system image openwrt-ramips-mt7621-ubnt-erx-initramfs-kernel.bin
Checking upgrade image...Upgrade image does not support the device. Upgrade failed.
</code></pre><p>则需要使用老版本的 Kenel 文件<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>刷入，步骤一样。</p><p>当过渡固件刷入后，输入<code>reboot</code>，重启 ER-X，等待重启完成后，可使用 SSH 重新登陆到 ER-X中。此时 ER-X 中已经是 Open-WRT 过渡固件，所以需要使用 root 用户登录。</p><p>使用 SCP 上传正式固件到 ER-X 中，再登陆 ER-X。</p><pre><code>$ scp /path/to/openwrt-ramips-mt7621-ubiquiti_edgerouterx-squashfs-sysupgrade.bin root@192.168.1.1:/tmp
$ ssh root@192.168.1.1
</code></pre><p>进入上传的正式版固件所在的目录，并进行刷写操作。</p><pre><code>$ cd /tmp
$ sysupgrade openwrt-ramips-mt7621-ubiquiti_edgerouterx-squashfs-sysupgrade.bin
</code></pre><p>等待一会儿，正式固件即可刷入成功并自动重启。重启完成后，即可登陆 Open-WRT 的 Web 管理界面。因为我们刷入的是 Lean 制作的固件，所以登陆账户为 root，密码为 password，可登陆后自行修改。</p><h2 id=三设置-er-x-为透明网关>三、设置 ER-X 为透明网关</h2><p>设置为透明网关的目的，是让局域网内其他机器能自动加速国外网站的访问，无需特殊设置。其基本操作，是在 Open-WRT 上建立加速服务，由主路由器（假设为 192.168.1.1）将 Open-WRT 的地址下发到局域网中的所有设备上。</p><p><strong><img src=/images/network-structure-1-1024x485.png alt=network-structure-1-1024x485></strong></p><p><strong>第一步，先要将 Open-WRT 设置为局域网内的网关。</strong></p><p>选取一个局域网内未使用的 IP 地址，将 Open-WRT 的 Lan 口设置为此静态地址，比如：192.168.1.2，子网掩码：255.255.255.0；网关：192.168.1.1，DNS 设置为192.168.1.1。由于我们依旧使用主路由器做 DHCP，所以需要将 Lan 的 DHCP 服务器关掉（忽略此接口）。然后将 Open-WRT 的 Lan 口连接到交换机或路由器的 Lan 口，如果可以的话，在路由器端也将此 Open-WRT 设备的 IP 设置为固定IP（192.168.1.2）。</p><p><img src=/images/open-wrt-lan-settings-1200x1322.png alt=open-wrt-lan-settings-1200x1322></p><p><strong>第二步，将主路由器的网关设置为 Open-WRT（192.168.1.2）。</strong></p><p>以 Ubnt Unifi 控制器为例，在 <em><strong>Settings > Networks > LAN > DHCP Controls</strong></em> 中，将 <em><strong>DHCP Gateway IP</strong></em> 设置为 Open-WRT 的 IP 192.168.1.2。</p><p><img src=/images/open-wrt-gateway-settings-1024x832.png alt=open-wrt-gateway-settings-1024x832></p><p>为测试是否正常，我们将电脑的网络断开重新连接，观察网关 IP 是否已自动获取为 Open-WRT 的 IP，并测试是否能正常上网。如果网关 IP 已修改，且能正常上网，则可以进行下一步。</p><p><strong>第三步，在 Open-WRT 上开启国外网站加速功能</strong>。</p><p>进入 <em><strong>Open-WRT > 服务 > ShadowsocksR Plus + > 服务器节点</strong></em> 中，添加节点或订阅（订阅需更新），然后进入同页面的的「客户端」中，选择一个节点，点击「保存&应用」，待页面显示「ShadowsocksR Plus+ 运行中」，即可使用电脑测试是否能正常网络加速。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=/posts/add-ssr-plus-in-lean-openwrt-firmware/>解决 Lean 固件编译后无 SSR-Plus 的问题</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=http://openwrt.jaru.eu.org/openwrt-18.06/targets/ramips/mt7621/openwrt-18.06-snapshot-r7911-f65330d27d-ramips-mt7621-ubnt-erx-initramfs-factory.tar target=_blank>老版本的 Kernel 文件</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var d=document,s=d.createElement("script");s.src="https://maolu.disqus.com/embed.js";s.setAttribute("data-timestamp",+new Date());(d.head||d.body).appendChild(s);})();});</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer><div class=site-footer-item><a href=https://movie.douban.com/people/victor_douban/ target=_blank>Douban</a></div><div class=site-footer-item><a href=https://t.me/vz_tg target=_blank>Telegram</a></div><div class=site-footer-item><a href=mailto:victor@maolu.one target=_blank>Email</a></div><div class=site-footer-item><a href=/index.xml target=_blank>RSS</a></div></div></div></div></article><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>